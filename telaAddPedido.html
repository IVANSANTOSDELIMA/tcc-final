<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../css/img/logoAtualizada.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/telaAddPedido.css">
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-straight/css/uicons-regular-straight.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css">
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-chubby/css/uicons-thin-chubby.css">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-thin-rounded/css/uicons-thin-rounded.css'>
    <link rel="stylesheet" href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <title>Cerealista Souza</title>

</head>

<body>
    <div class="containerTotal">
        <div class="containerButtons">
            <img src="css/img/Logotipo-Cerealista.png" alt="logoLetra" id="logo">
            <div class="rowbutton"><i class="fi fi-rs-apps"></i><button type="button"
                    onclick="window.location.href='telaInicio.html'">Dashboard</button>
                <i class="fi fi-ss-angle-right" style="font-size: 20px; position: absolute; top: 45%; left: 60%;"></i>
            </div>
            <div class="rowbutton"><i class="fi fi-tr-users"></i><button type="button"
                    onclick="window.location.href='telafuncionarios.html'">Funcionarios</button><i
                    class="fi fi-ss-angle-right" style="font-size: 20px; position: absolute; top: 45%; left: 70%;"></i>
            </div>
            <div class="rowbutton"><i class="fi fi-tr-boxes"></i><button type="button"
                    onclick="window.location.href='telaprodutos.html'">Estoque</button><i class="fi fi-ss-angle-right"
                    style="font-size: 20px; position: absolute; top: 45%; left: 50%;"></i>
            </div>
            <div class="rowbutton"><i class="fi fi-tr-chart-line-up"></i><button type="button"
                    onclick="window.location.href='telarelatoriodeProdutos.html'">Movimenta√ß√µes</button><i
                    class="fi fi-ss-angle-right" style="font-size: 20px; position: absolute; top: 45%; left: 80%;"></i>
            </div>
            <div class="rowbutton"><i class="fi fi-rr-shopping-bag"></i><button type="button"
                    onclick="window.location.href='telaAddPedido.html'">Pedidos</button>

            </div>
        </div>
        <header id="headersuperior">
            <div class="config">
                <div id="imageUser"><img src="" alt=""></div>
            </div>
        </header>
        <!-- ------------------------------------------------------------------------------------- -->
        <div class="container">
            <div class="form-container">
                <form id="movimentacaoForm">
                    <div class="form-section">
                        <h2>Informa√ß√µes da Movimenta√ß√£o</h2>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">Tipo de Movimenta√ß√£o</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="entrada" name="id_tipo_movimentacao" value="E" checked>
                                        <label for="entrada">Entrada</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="saida" name="id_tipo_movimentacao" value="S">
                                        <label for="saida">Sa√≠da</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="data_movimentacao" class="required">Data</label>
                                <input type="date" id="data_movimentacao" name="data_movimentacao" required>
                            </div>

                            <div class="form-group">
                                <label for="hora_movimentacao">Hora</label>
                                <input type="time" id="hora_movimentacao" name="hora_movimentacao">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="id_participante" class="required">Participante</label>
                                <div class="autocomplete">
                                    <input type="text" id="participante_nome" placeholder="Buscar participante"
                                        required>
                                    <input type="hidden" id="id_participante" name="id_participante">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="id_funcionario" class="required">Funcion√°rio Respons√°vel</label>
                                <div class="autocomplete">
                                    <input type="text" id="funcionario_nome" placeholder="Buscar funcion√°rio" required>
                                    <input type="hidden" id="id_funcionario" name="id_funcionario">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="numero_documento">N¬∫ Documento/NF</label>
                                <input type="text" id="numero_documento" name="numero_documento">
                            </div>

                            <div class="form-group">
                                <label for="observacoes">Observa√ß√µes</label>
                                <textarea id="observacoes" name="observacoes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Itens da Movimenta√ß√£o</h2>

                        <table id="itensTable">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Valor Unit√°rio (R$)</th>
                                    <th>Subtotal (R$)</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="item-row-1" class="item-row">
                                    <td data-label="Item">1</td>
                                    <td data-label="Produto">
                                        <div class="autocomplete">
                                            <input type="text" class="produto-nome" placeholder="Buscar produto"
                                                required>
                                            <input type="hidden" class="id-produto" name="itens[0][id_produto]">
                                        </div>
                                    </td>
                                    <td data-label="Quantidade">
                                        <input type="number" class="quantidade" name="itens[0][quantidade]" min="0.01"
                                            step="0.01" value="1" required>
                                    </td>
                                    <td data-label="Valor Unit√°rio">
                                        <input type="number" class="valor-unitario" name="itens[0][valor_unitario]"
                                            min="0.01" step="0.01" value="0.00" required>
                                    </td>
                                    <td data-label="Subtotal" class="subtotal">0.00</td>
                                    <td data-label="A√ß√µes" class="action-cell">
                                        <span class="item-action delete-btn" title="Remover item">üóëÔ∏è</span>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="4" align="right">Total:</td>
                                    <td id="total-value">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>

                        <button type="button" class="add-item-btn" id="addItemBtn">+ Adicionar Item</button>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="secondary" id="limparBtn">Limpar</button>
                        <button type="submit" id="button-salvar">Salvar Movimenta√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal sair--------------------------------------------------------------------------------->
        <dialog id="modalLogin">
            <button id="sairLogin">Sair</button>
        </dialog>

        <!-- --------------------------------------------------------------------------------->
    </div>
    <script>
        const dialogLogin = document.querySelector("#modalLogin");
        const openSair = document.querySelector("#imageUser");

        openSair.addEventListener("click", (e) => {
            dialogLogin.showModal();
        });

        dialogLogin.addEventListener("click", (event) => {
            const rectLogin = dialogLogin.getBoundingClientRect();
            if (
                event.clientX < rectLogin.left ||
                event.clientX > rectLogin.right ||
                event.clientY < rectLogin.top ||
                event.clientY > rectLogin.bottom
            ) {
                dialogLogin.close();
            }
        });

        //--------------------------------------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', function () {
            // Simulando dados para o autocomplete
            /* const participantes = [
                { id: 1, nome: "Fornecedor ABC Ltda" },
                { id: 2, nome: "Cliente XYZ Com√©rcio" },
                { id: 3, nome: "Distribuidor Regional" }
            ];

            const funcionarios = [
                { id: 1, nome: "Jo√£o Silva" },
                { id: 2, nome: "Maria Oliveira" },
                { id: 3, nome: "Carlos Santos" }
            ];

            const produtos = [
                { id: 1, nome: "Arroz Integral", unidade: "kg" },
                { id: 2, nome: "Feij√£o Carioca", unidade: "kg" },
                { id: 3, nome: "Milho para Pipoca", unidade: "kg" },
                { id: 4, nome: "Trigo para Kibe", unidade: "kg" },
                { id: 5, nome: "Lentilha", unidade: "kg" }
            ]; */

            // Inicializar data com data atual
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            document.getElementById('data_movimentacao').value = formattedDate;

            // Configurar autocomplete para participantes
            setupAutocomplete(document.getElementById('participante_nome'), participantes, 'id_participante');

            // Configurar autocomplete para funcion√°rios
            setupAutocomplete(document.getElementById('funcionario_nome'), funcionarios, 'id_funcionario');

            // Configurar autocomplete para produtos na primeira linha
            setupAutocomplete(document.querySelector('.produto-nome'), produtos, document.querySelector('.id-produto').id);

            // Adicionar evento para calcular subtotal quando a quantidade ou valor unit√°rio mudar
            document.querySelector('.quantidade').addEventListener('input', updateSubtotal);
            document.querySelector('.valor-unitario').addEventListener('input', updateSubtotal);

            // Fun√ß√£o para adicionar um novo item
            /* document.getElementById('addItemBtn').addEventListener('click', function () {
                const itemsTable = document.getElementById('itensTable').getElementsByTagName('tbody')[0];
                const itemCount = itemsTable.getElementsByClassName('item-row').length;
                const newRow = document.createElement('tr');
                newRow.id = `item-row-${itemCount + 1}`;
                newRow.className = 'item-row';

                newRow.innerHTML = `
                    <td data-label="Item">${itemCount + 1}</td>
                    <td data-label="Produto">
                        <div class="autocomplete">
                            <input type="text" class="produto-nome" placeholder="Buscar produto" required>
                            <input type="hidden" class="id-produto" name="itens[${itemCount}][id_produto]">
                        </div>
                    </td>
                    <td data-label="Quantidade">
                        <input type="number" class="quantidade" name="itens[${itemCount}][quantidade]" min="0.01" step="0.01" value="1" required>
                    </td>
                    <td data-label="Valor Unit√°rio">
                        <input type="number" class="valor-unitario" name="itens[${itemCount}][valor_unitario]" min="0.01" step="0.01" value="0.00" required>
                    </td>
                    <td data-label="Subtotal" class="subtotal">0.00</td>
                    <td data-label="A√ß√µes" class="action-cell">
                        <span class="item-action delete-btn" title="Remover item">üóëÔ∏è</span>
                    </td>
                `;

                itemsTable.appendChild(newRow);

                // Configurar autocomplete para o novo produto
                setupAutocomplete(newRow.querySelector('.produto-nome'), produtos, newRow.querySelector('.id-produto').id);

                // Adicionar eventos para calcular subtotal
                newRow.querySelector('.quantidade').addEventListener('input', updateSubtotal);
                newRow.querySelector('.valor-unitario').addEventListener('input', updateSubtotal);

                // Adicionar evento para remover item
                newRow.querySelector('.delete-btn').addEventListener('click', function () {
                    if (itemsTable.getElementsByClassName('item-row').length > 1) {
                        newRow.remove();
                        updateItemNumbers();
                        calculateTotal();
                    } else {
                        alert('√â necess√°rio pelo menos um item na movimenta√ß√£o.');
                    }
                });
            }); */

            // Adicionar evento para remover item na primeira linha
            document.querySelector('.delete-btn').addEventListener('click', function () {
                const itemsTable = document.getElementById('itensTable').getElementsByTagName('tbody')[0];
                if (itemsTable.getElementsByClassName('item-row').length > 1) {
                    document.getElementById('item-row-1').remove();
                    updateItemNumbers();
                    calculateTotal();
                } else {
                    alert('√â necess√°rio pelo menos um item na movimenta√ß√£o.');
                }
            });

            // Bot√£o limpar
            document.getElementById('limparBtn').addEventListener('click', function () {
                if (confirm('Deseja realmente limpar todos os campos do formul√°rio?')) {
                    document.getElementById('movimentacaoForm').reset();

                    // Definir data atual novamente
                    document.getElementById('data_movimentacao').value = formattedDate;

                    // Limpar tabela de itens exceto a primeira linha
                    const itemsTable = document.getElementById('itensTable').getElementsByTagName('tbody')[0];
                    const rows = itemsTable.getElementsByClassName('item-row');

                    while (rows.length > 1) {
                        rows[rows.length - 1].remove();
                    }

                    // Limpar a primeira linha
                    const firstRow = rows[0];
                    firstRow.querySelector('.produto-nome').value = '';
                    firstRow.querySelector('.id-produto').value = '';
                    firstRow.querySelector('.quantidade').value = '1';
                    firstRow.querySelector('.valor-unitario').value = '0.00';
                    firstRow.querySelector('.subtotal').textContent = '0.00';

                    calculateTotal();
                }
            });

            // Enviar formul√°rio
            document.getElementById('movimentacaoForm').addEventListener('submit', function (e) {
                e.preventDefault();

                // Valida√ß√£o b√°sica
                const participanteId = document.getElementById('id_participante').value;
                const funcionarioId = document.getElementById('id_funcionario').value;

                if (!participanteId) {
                    alert('Selecione um participante v√°lido.');
                    return false;
                }

                if (!funcionarioId) {
                    alert('Selecione um funcion√°rio respons√°vel.');
                    return false;
                }

                // Validar itens
                let invalid = false;
                document.querySelectorAll('.item-row').forEach(row => {
                    const produtoId = row.querySelector('.id-produto').value;
                    const quantidade = parseFloat(row.querySelector('.quantidade').value);
                    const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value);

                    if (!produtoId) {
                        alert('Selecione um produto v√°lido para todos os itens.');
                        invalid = true;
                        return;
                    }

                    if (isNaN(quantidade) || quantidade <= 0) {
                        alert('A quantidade deve ser maior que zero para todos os itens.');
                        invalid = true;
                        return;
                    }

                    if (isNaN(valorUnitario) || valorUnitario <= 0) {
                        alert('O valor unit√°rio deve ser maior que zero para todos os itens.');
                        invalid = true;
                        return;
                    }
                });

                if (invalid) {
                    return false;
                }

                // Criar objeto com os dados do formul√°rio
                const formData = {
                    id_tipo_movimentacao: document.querySelector('input[name="id_tipo_movimentacao"]:checked').value,
                    data_movimentacao: document.getElementById('data_movimentacao').value,
                    hora_movimentacao: document.getElementById('hora_movimentacao').value,
                    id_participante: parseInt(participanteId),
                    id_funcionario: parseInt(funcionarioId),
                    numero_documento: document.getElementById('numero_documento').value,
                    observacoes: document.getElementById('observacoes').value,
                    itens: []
                };

                // Coletar os itens
                document.querySelectorAll('.item-row').forEach((row, index) => {
                    formData.itens.push({
                        item: index + 1,
                        id_produto: parseInt(row.querySelector('.id-produto').value),
                        quantidade: parseFloat(row.querySelector('.quantidade').value),
                        valor_unitario: parseFloat(row.querySelector('.valor-unitario').value)
                    });
                });

                // Enviar os dados (simula√ß√£o)
                console.log('Dados do formul√°rio:', formData);
                alert('Movimenta√ß√£o registrada com sucesso!');

                // Aqui voc√™ adicionaria o c√≥digo para enviar os dados para o servidor

                // Limpar o formul√°rio ap√≥s o envio
                document.getElementById('limparBtn').click();
            });

            // Fun√ß√µes auxiliares
            function updateSubtotal() {
                const row = this.closest('tr');
                const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
                const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value) || 0;
                const subtotal = quantidade * valorUnitario;
                row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
                calculateTotal();
            }

            function calculateTotal() {
                let total = 0;
                document.querySelectorAll('.subtotal').forEach(cell => {
                    total += parseFloat(cell.textContent) || 0;
                });
                document.getElementById('total-value').textContent = total.toFixed(2);
            }

            function updateItemNumbers() {
                const rows = document.querySelectorAll('.item-row');
                rows.forEach((row, index) => {
                    const itemNum = index + 1;
                    row.id = `item-row-${itemNum}`;
                    row.querySelector('td:first-child').textContent = itemNum;

                    // Atualizar o √≠ndice nos nomes dos campos
                    const inputQuantidade = row.querySelector('.quantidade');
                    const inputValorUnitario = row.querySelector('.valor-unitario');
                    const inputIdProduto = row.querySelector('.id-produto');

                    inputQuantidade.name = `itens[${index}][quantidade]`;
                    inputValorUnitario.name = `itens[${index}][valor_unitario]`;
                    inputIdProduto.name = `itens[${index}][id_produto]`;
                });
            }

            function setupAutocomplete(input, items, targetId) {
                let currentFocus;

                input.addEventListener("input", function () {
                    let a, b, i, val = this.value;
                    closeAllLists();
                    if (!val) { return false; }
                    currentFocus = -1;

                    a = document.createElement("div");
                    a.setAttribute("class", "autocomplete-items");
                    this.parentNode.appendChild(a);

                    for (i = 0; i < items.length; i++) {
                        if (items[i].nome.toLowerCase().includes(val.toLowerCase())) {
                            b = document.createElement("div");
                            b.innerHTML = items[i].nome;
                            b.innerHTML += "<input type='hidden' value='" + items[i].id + "'>";
                            b.addEventListener("click", function () {
                                input.value = this.textContent;
                                const idValue = this.getElementsByTagName("input")[0].value;
                                if (targetId === 'id_participante' || targetId === 'id_funcionario') {
                                    document.getElementById(targetId).value = idValue;
                                } else {
                                    input.parentNode.querySelector('.id-produto').value = idValue;
                                }
                                closeAllLists();
                            });
                            a.appendChild(b);
                        }
                    }
                });

                input.addEventListener("keydown", function (e) {
                    let x = document.getElementsByClassName("autocomplete-items")[0];
                    if (x) x = x.getElementsByTagName("div");
                    if (e.keyCode == 40) { // seta para baixo
                        currentFocus++;
                        addActive(x);
                    } else if (e.keyCode == 38) { // seta para cima
                        currentFocus--;
                        addActive(x);
                    } else if (e.keyCode == 13) { // enter
                        e.preventDefault();
                        if (currentFocus > -1) {
                            if (x) x[currentFocus].click();
                        }
                    }
                });

                function addActive(x) {
                    if (!x) return false;
                    removeActive(x);
                    if (currentFocus >= x.length) currentFocus = 0;
                    if (currentFocus < 0) currentFocus = (x.length - 1);
                    x[currentFocus].classList.add("autocomplete-active");
                }

                function removeActive(x) {
                    for (let i = 0; i < x.length; i++) {
                        x[i].classList.remove("autocomplete-active");
                    }
                }

                function closeAllLists(elmnt) {
                    const x = document.getElementsByClassName("autocomplete-items");
                    for (let i = 0; i < x.length; i++) {
                        if (elmnt != x[i] && elmnt != input) {
                            x[i].parentNode.removeChild(x[i]);
                        }
                    }
                }

                document.addEventListener("click", function (e) {
                    closeAllLists(e.target);
                });
            }
        });
    </script>
    <script src="integracoes/addProdutoIntegration.js"></script>

</html>